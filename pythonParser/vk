from selenium import webdriver

import time

import psycopg2
import psycopg2.extras

try:
    conn = psycopg2.connect("dbname='vk' user='postgres' host='127.0.0.1' password='1'")
except:
    print("Не удалось подключиться к БД")
# Создаем курсор для работы
cur = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
"""
try:
    cur.execute("SELECT * FROM musicband")
except:
    print("Запрос не удался")
# for row in cur:
#    print(row)
results = cur.fetchall()
for row in results:
    print(row['nameband'])
musicbandname = "VVVVVVVVV"
try:
    # Попожить найденную группу
    # cur.execute("INSERT INTO public.musicband(nameband) VALUES (upper('"+musicbandname+"'))")
    cur.execute(
        "INSERT INTO public.vkuser_musicband(vkuserid, musicbandid)	VALUES ('12', (SELECT musicbandid FROM public.musicband WHERE nameband = upper('" + musicbandname + "')))")
    conn.commit()
    print("Положил")
except psycopg2.DatabaseError as e:
    if conn:
        conn.rollback()
    print('Error %s' % e)
    print("Запрос INSERT не удался")
# INSERT INTO public.musicband(nameband) VALUES (upper('"+musicbandname+"'))
# "INSERT INTO public.vkuser_musicband(vkuserid, musicbandid)	VALUES ('12', (SELECT musicbandid FROM public.musicband WHERE nameband = upper('"+musicbandname+"')))"
"""

"""
print("тип arr:", type(results))
print("Кол-во полей с строке: ", len(results))
print("Доступ по индексу:", results[0][1])
#Вывод названий столбцов в бд

colnames = [desc[0] for desc in cur.description]
print(colnames)
print(results)
#Вывод результата из бд, криво будет работать если бд изменится
#TODO как обращаться к столбцу по имени?
for i in range(0, len(results)):
    print(results[i][1])

"""
#Список пользователей
#TODO сделать ввод из файла
audios = (
    # User ids here
    '42513160',
    '54986774',
    '42513160',
    '42513160',
    '167495259',
    '70855032',
    '76995859'
)

baseurl = "https://vk.com/"
username = "89821469162"
password = "Zx1#qwerty1906ugjoij"

xpaths = {
    'usernameTxtBox': "//*[@id='index_email']",
    'passwordTxtBox': "//*[@id='index_pass']",
    'submitButton': "//*[@id='index_login_button']"
}

mydriver = webdriver.Firefox(executable_path=r'D:\parser\geckodriver.exe')
mydriver.get(baseurl)
mydriver.maximize_window()

mydriver.find_element_by_xpath(xpaths['usernameTxtBox']).clear()
mydriver.find_element_by_xpath(xpaths['usernameTxtBox']).send_keys(username)
mydriver.find_element_by_xpath(xpaths['passwordTxtBox']).clear()
mydriver.find_element_by_xpath(xpaths['passwordTxtBox']).send_keys(password)
mydriver.find_element_by_xpath(xpaths['submitButton']).click()

print('тормозим')
time.sleep(5)
print('поехали')


# Функиця установки музыки в бд
def setMusic(musicbandname):
    try:
        # Попожить найденную группу
        cur.execute("INSERT INTO public.musicband(nameband) VALUES (upper('" + musicbandname + "'))")
        conn.commit()
        print("Положил в БД")
    except psycopg2.DatabaseError as e:
        if conn:
            conn.rollback()
        print('Error %s' % e)
        print("Запрос INSERT группы не удался")


def setUserMusic(userid, musicbandname):
    try:
        # Попожить связку userid musicbamdname группу
        cur.execute(
            "INSERT INTO public.vkuser_musicband(vkuserid, musicbandid)	VALUES ('" + userid + "', (SELECT musicbandid FROM public.musicband WHERE nameband = upper('" + musicbandname + "')))")
        conn.commit()
        print("Положил")
    except psycopg2.DatabaseError as e:
        if conn:
            conn.rollback()
        print('Error %s' % e)
        print("Запрос INSERT пользователя не удался")


def setUser(userid):
    try:
        # Попожить пользователя
        # TODO имя пользователя?
        cur.execute("INSERT INTO public.vkuser (uservkid) VALUES ('"+userid+"')")
        conn.commit()
        print("Положил пользователя")
    except psycopg2.DatabaseError as e:
        if conn:
            conn.rollback()
        print('Error %s' % e)
        print("Запрос INSERT пользователя не удался")


# Парсинг найденного массива
def viewMusic(array):
    for i in range(0, len(array)):
        setMusic(array[i].text)
        print(i, array[i].text)
        setUserMusic(audio, array[i].text)


for audio in audios:
    urlaudio = baseurl + 'audios' + audio
    try:
        mydriver.get(urlaudio)
        print(urlaudio)
        print(mydriver.current_url)
        if urlaudio == mydriver.current_url:
            for i in range(100):
                mydriver.execute_script("window.scrollBy(0,1000)")
            setUser(audio)
            content = mydriver.find_elements_by_css_selector('a.audio_row__performer')
            print("\nКоличество треков = ", len(content))
            viewMusic(content)
            time.sleep(2)
        else:
            print("Доступ к аудио закрыт id", audio)
            continue
    except:
        print("не удалось обратиться у url")
        continue
# Закрываем соединение с БД
cur.close()
conn.close()
